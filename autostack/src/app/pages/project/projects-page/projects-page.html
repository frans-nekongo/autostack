<div class="flex flex-col p-4">
    <div class="flex justify-between min-w-full mb-10">
        <p class="text-xl font-bold">All Projects</p>
        <div class="flex gap-3 w-fit">
            <!-- Search Input -->
            <div class="border rounded w-72">
                <input class="bg-none py-1 px-2 placeholder:text-sm w-full focus:outline-none focus:border-none"
                    placeholder="Search for a project" [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange($event)"
                    [disabled]="(isLoading$ | async) ?? false" />
            </div>

            <!-- Sort Dropdown -->
            <div class="relative">
                <button class="flex items-center bg-white-900 py-1 px-2 rounded gap-2 border" (click)="toggleDropdown()"
                    [disabled]="(isLoading$ | async) || (projectsCount$ | async) === 0">
                    <p class="text-sm text-ocean-500">
                        {{ currentSortLabel }}
                    </p>
                    <ng-icon class="text-ocean-500" name="heroChevronDown" size="15"></ng-icon>
                </button>

                @if (isDropdownOpen) {
                <div class="absolute right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 min-w-[200px]">
                    @for (option of sortOptions; track option.value) {
                    <button (click)="onSortChange(option.value)" [class.bg-ocean-50]="sortOption === option.value"
                        class="w-full flex items-center justify-between px-3 py-2 text-sm hover:bg-gray-50 first:rounded-t-lg last:rounded-b-lg">
                        <span>{{ option.label }}</span>
                        @if (sortOption === option.value) {
                        <span class="text-ocean-500">âœ“</span>
                        }
                    </button>
                    }
                </div>
                }
            </div>

            <a class="flex items-center bg-ocean-500 py-1 px-2 rounded gap-2" href="/create-project">
                <svg width="15" height="15" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_55_314)">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M11.875 18.125L4.375 15V5.00003L11.875 1.87503V18.125ZM3.26875 16.57C3.04106 16.475 2.84656 16.3148 2.70976 16.1095C2.57296 15.9042 2.49998 15.663 2.5 15.4163V4.58378C2.49998 4.33707 2.57296 4.09587 2.70976 3.89056C2.84656 3.68525 3.04106 3.52502 3.26875 3.43003L11.1538 0.143783C11.4387 0.0250248 11.7486 -0.0215275 12.0559 0.00825979C12.3632 0.0380471 12.6584 0.143252 12.9152 0.314533C13.1721 0.485815 13.3827 0.717872 13.5283 0.9901C13.6739 1.26233 13.7501 1.5663 13.75 1.87503V2.50003H15.3125C16.52 2.50003 17.5 3.47878 17.5 4.68753V15.3125C17.5 15.8927 17.2695 16.4491 16.8593 16.8593C16.4491 17.2696 15.8927 17.5 15.3125 17.5H13.75V18.125C13.7501 18.4338 13.6739 18.7377 13.5283 19.01C13.3827 19.2822 13.1721 19.5143 12.9152 19.6855C12.6584 19.8568 12.3632 19.962 12.0559 19.9918C11.7486 20.0216 11.4387 19.975 11.1538 19.8563L3.26875 16.57ZM13.75 15.625H15.3125C15.3954 15.625 15.4749 15.5921 15.5335 15.5335C15.5921 15.4749 15.625 15.3954 15.625 15.3125V4.68753C15.625 4.60465 15.5921 4.52517 15.5335 4.46656C15.4749 4.40796 15.3954 4.37503 15.3125 4.37503H13.75V15.625Z"
                            fill="#F8F8F8" />
                    </g>
                    <defs>
                        <clipPath id="clip0_55_314">
                            <rect width="20" height="20" fill="black" />
                        </clipPath>
                    </defs>
                </svg>
                <p class="text-sm text-white-900">Create Project</p>
            </a>
        </div>
    </div>

    <!-- Loading State -->
    @if (isLoading$ | async) {
    <div class="flex justify-center items-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-ocean-500"></div>
        <p class="ml-3">Loading projects...</p>
    </div>
    } @else {
    <!-- All Projects -->
    <div class="flex flex-col gap-3">
        @for (item of filteredProjects$ | async; track item.id) {
        <div class="flex flex-col gap-1 border-b pb-4 cursor-pointer" (click)="onSelect(item)">
            <div class="flex gap-2">
                <img [src]="item.avatarDataUrl" width="30" class="border rounded p-1"/>
                <p class="text-lg text-ocean-600 font-bold hover:underline hover:decoration-2 hover:text-ocean-500">
                    {{ item.name }}
                </p>

            </div>
            <p class="text-xs text-slate-700">{{ item.description || 'No description' }}</p>
            <p class="text-xs text-slate-500">
                Updated {{ formatRelativeTime(item.metadata?.lastModified!) }} ago
            </p>
        </div>
        }
    </div>
    }

    <!-- Error State -->
    @if ((error$ | async)) {
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
        <p class="text-red-700">{{ error$ | async }}</p>
        <button class="mt-2 text-sm text-red-600 hover:text-red-800 underline" (click)="onRefresh()">
            Try again
        </button>
    </div>
    }

    <!-- No Results State -->
    @if (!(isLoading$ | async) && !(error$ | async) && (filteredProjects$ | async)?.length === 0) {
    <div class="text-center py-12">
        <ng-icon name="heroFolder" class="text-gray-300 mb-3" size="48"></ng-icon>
        <p class="text-gray-500">
            @if (searchTerm) {
            No projects found matching "{{ searchTerm }}"
            } @else {
            No projects available. Create your first project!
            }
        </p>
        @if (searchTerm) {
        <button class="mt-3 text-sm text-ocean-600 hover:text-ocean-800 underline" (click)="onSearchChange('')">
            Clear search
        </button>
        }
    </div>
    }



    <!-- Results Count -->
    @if ((filteredProjects$ | async)?.length! > 0 && !(isLoading$ | async)) {
    <div class="text-center py-4 text-sm text-gray-500">
        Showing {{ (filteredProjects$ | async)?.length }} of {{ projectsCount$ | async }} projects
    </div>
    }
</div>