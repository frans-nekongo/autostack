<div class="flex flex-col h-full w-full overflow-hidden">
  <!-- main content area -->
  <div class="flex-col flex-1 overflow-y-auto">
    @if (currentChat$ | async; as chat) {
    <div class="flex justify-end">
      <div
        class="flex justify-end max-w-[50%] p-5 bg-ocean-50 rounded-tr-lg rounded-br-lg rounded-tl-lg rounded-bl-none">
        <p class="text-sm">{{ chat.prompt }}</p>
      </div>
    </div>

    <div class="flex flex-col gap-3 mt-10">
      <div class="flex justify-between">
        <p class="text-xl">Initial Generated Schema</p>
        <div class="flex gap-3">
          <button class="flex items-center bg-green-500 py-1 px-2 rounded" (click)="onEditSchema()"
            [disabled]="chat.hasValidationError">
            <p class="text-sm text-white-900">{{ isEditMode ? 'Cancel Edit' : 'Edit Schema' }}</p>
          </button>

          <button class="flex items-center bg-ocean-500 py-1 px-2 rounded" (click)="onGenerateProject()"
            [disabled]="isEditMode || chat.hasValidationError">
            <p class="text-sm text-white-900">Generate Project</p>
          </button>
        </div>
      </div>

      @if (chat.hasValidationError && chat.validationError) {
      <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
        <div class="flex items-start gap-3">
          <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-red-800 mb-2">Validation Error</h3>
            <p class="text-red-700 mb-4">{{ chat.validationError.message }}</p>

            @if (chat.validationError.unsupported_technologies && chat.validationError.unsupported_technologies.length >
            0) {
            <div class="mb-3">
              <p class="font-medium text-red-800 mb-1">Unsupported Technologies:</p>
              <ul class="list-disc list-inside text-red-700">
                @for (tech of chat.validationError.unsupported_technologies; track tech) {
                <li>{{ tech }}</li>
                }
              </ul>
            </div>
            }

            @if (chat.validationError.unsupported_frameworks && chat.validationError.unsupported_frameworks.length > 0)
            {
            <div class="mb-3">
              <p class="font-medium text-red-800 mb-1">Unsupported Frameworks:</p>
              <ul class="list-disc list-inside text-red-700">
                @for (fw of chat.validationError.unsupported_frameworks; track fw) {
                <li>{{ fw }}</li>
                }
              </ul>
            </div>
            }

            @if (chat.validationError.unsupported_component_types &&
            chat.validationError.unsupported_component_types.length > 0) {
            <div class="mb-3">
              <p class="font-medium text-red-800 mb-1">Unsupported Component Types:</p>
              <ul class="list-disc list-inside text-red-700">
                @for (type of chat.validationError.unsupported_component_types; track type) {
                <li>{{ type }}</li>
                }
              </ul>
            </div>
            }

            @if (chat.validationError.supported_technologies) {
            <div class="mt-4 mb-3">
              <p class="font-medium text-green-800 mb-2">Supported Technologies:</p>
              <div class="bg-green-50 border border-green-200 rounded p-3">
                @for (category of objectKeys(chat.validationError.supported_technologies); track category) {
                <div class="mb-2">
                  <span class="font-medium text-green-900">{{ category }}:</span>
                  <span class="text-green-700 ml-2">
                    {{ chat.validationError.supported_technologies[category].join(', ') }}
                  </span>
                </div>
                }
              </div>
            </div>
            }

            @if (chat.validationError.supported_frameworks && chat.validationError.supported_frameworks.length > 0) {
            <div class="mb-3">
              <p class="font-medium text-green-800 mb-2">Supported Frameworks:</p>
              <div class="bg-green-50 border border-green-200 rounded p-3">
                <p class="text-sm text-green-700">
                  {{ chat.validationError.supported_frameworks.join(', ') }}
                </p>
              </div>
            </div>
            }

            <button class="mt-4 px-4 py-2 bg-ocean-500 text-white-900 rounded hover:bg-ocean-600"
              (click)="openEditPromptModal()">
              Edit Prompt & Retry
            </button>
          </div>
        </div>
      </div>
      }

      @if (chat.initialSchema?.project) {
      <div class="flex flex-col gap-4">

        @if (isEditMode) {
        <div class="flex gap-3 mt-4">
          <button class="px-4 py-2 rounded border" [class.bg-ocean-500]="editSection === 'project'"
            [class.text-white-900]="editSection === 'project'" [class.border-ocean-500]="editSection === 'project'"
            [class.bg-white-900]="editSection !== 'project'" [class.text-ocean-500]="editSection !== 'project'"
            [class.border-ocean-300]="editSection !== 'project'" (click)="editSection = 'project'">
            <p class="text-sm">Project Details</p>
          </button>
          <button class="px-4 py-2 rounded border" [class.bg-ocean-500]="editSection === 'components'"
            [class.text-white-900]="editSection === 'components'"
            [class.border-ocean-500]="editSection === 'components'" [class.bg-white-900]="editSection !== 'components'"
            [class.text-ocean-500]="editSection !== 'components'"
            [class.border-ocean-300]="editSection !== 'components'" (click)="editSection = 'components'">
            <p class="text-sm">Components</p>
          </button>
          <button class="px-4 py-2 rounded border" [class.bg-ocean-500]="editSection === 'connections'"
            [class.text-white-900]="editSection === 'connections'"
            [class.border-ocean-500]="editSection === 'connections'"
            [class.bg-white-900]="editSection !== 'connections'" [class.text-ocean-500]="editSection !== 'connections'"
            [class.border-ocean-300]="editSection !== 'connections'" (click)="editSection = 'connections'">
            <p class="text-sm">Connections</p>
          </button>
        </div>
        }

        @if (!isEditMode || editSection === 'project') {
        <div class="flex flex-col gap-4">
          <p class="text-lg">Project Details</p>

          @if (isEditMode && editSection === 'project') {
          <!-- Edit Mode -->
          <div class="flex flex-col gap-4">
            <div class="flex flex-col gap-1">
              <label class="text-slate-700">Name</label>
              <input [(ngModel)]="editedSchema.project.name"
                class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10" />
            </div>

            <div class="flex flex-col gap-1">
              <label class="text-slate-700">Author</label>
              <input [(ngModel)]="editedSchema.project.author"
                class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10" />
            </div>

            <div class="flex flex-col gap-1">
              <label class="text-slate-700">Version</label>
              <input [(ngModel)]="editedSchema.project.version"
                class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10" />
            </div>

            <div class="flex flex-col gap-1">
              <label class="text-slate-700">Description</label>
              <textarea rows="4" [(ngModel)]="editedSchema.project.description"
                class="text-slate-500 focus:text-slate-700 min-h-[50px] max-h-[120px] border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10 resize-none">
              </textarea>
            </div>

            <button class="flex items-center justify-center bg-ocean-500 py-2 px-4 rounded max-w-[120px]"
              (click)="saveSection()">
              <p class="text-sm text-white-900">Save</p>
            </button>
          </div>
          } @else {
          <!-- View Mode -->
          <table>
            <thead>
              <tr>
                <th class="py-2 border-b border-ocean-300 bg-ocean-100 rounded-t-lg" colspan="2">
                  <p class="block text-sm antialiased leading-normal text-slate-900">Project Details</p>
                </th>
              </tr>
            </thead>
            <tbody class="rounded-b-lg">
              <tr class="even:bg-ocean-50/50">
                <td class="p-2">
                  <p class="block text-sm antialiased leading-normal text-slate-500">Name</p>
                </td>
                <td class="p-2">
                  <p class="block text-sm antialiased leading-normal text-slate-500">{{ editedSchema.project.name }}</p>
                </td>
              </tr>
              <tr class="even:bg-ocean-50/50">
                <td class="p-2">
                  <p class="block text-sm antialiased leading-normal text-slate-500">Author</p>
                </td>
                <td class="p-2">
                  <p class="block text-sm antialiased leading-normal text-slate-500">{{ editedSchema.project.author }}
                  </p>
                </td>
              </tr>
              <tr class="even:bg-ocean-50/50">
                <td class="p-2">
                  <p class="block text-sm antialiased leading-normal text-slate-500">Version</p>
                </td>
                <td class="p-2">
                  <p class="block text-sm antialiased leading-normal text-slate-500">{{ editedSchema.project.version }}
                  </p>
                </td>
              </tr>
              <tr class="even:bg-ocean-50/50">
                <td class="p-2">
                  <p class="block text-sm antialiased leading-normal text-slate-500">Description</p>
                </td>
                <td class="p-2">
                  <p class="block text-sm antialiased leading-normal text-slate-500">{{ editedSchema.project.description
                    }}</p>
                </td>
              </tr>
            </tbody>
          </table>
          }
        </div>
        }

        <!-- Components Section -->
        @if (!isEditMode || editSection === 'components') {
        <div class="flex flex-col gap-4">
          <p class="text-lg mt-4">Components</p>

          @if (isEditMode && editSection === 'components') {
          <!-- Edit Mode -->
          <div class="flex flex-col gap-4">
            @for (component of editedSchema.components; track $index) {
            <div class="border border-ocean-300 rounded p-4 flex flex-col gap-3">
              <div class="flex justify-between items-center">
                <p class="font-semibold text-slate-700">Component {{ $index + 1 }}</p>
                <button class="text-red-500 text-sm" (click)="removeComponent($index)">
                  Remove
                </button>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div class="flex flex-col gap-1">
                  <label class="text-slate-700">Name</label>
                  <input [(ngModel)]="component.name"
                    class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10" />
                </div>

                <div class="flex flex-col gap-1">
                  <label class="text-slate-700">Component ID</label>
                  <input [(ngModel)]="component.component_id"
                    class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10" />
                </div>

                <div class="flex flex-col gap-1">
                  <label class="text-slate-700">Technology</label>
                  <select [(ngModel)]="component.technology" (ngModelChange)="onTechnologyChange(component)"
                    class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10">
                    <option value="nodejs">Node.js</option>
                    <option value="python">Python</option>
                    <option value="java">Java</option>
                    <option value="go">Go</option>
                    <option value="postgresql">PostgreSQL</option>
                    <option value="mysql">MySQL</option>
                    <option value="mongodb">MongoDB</option>
                    <option value="sqlite">SQLite</option>
                    <option value="redis">Redis</option>
                    <option value="kafka">Kafka</option>
                  </select>
                </div>

                <div class="flex flex-col gap-1">
                  <label class="text-slate-700">Framework</label>
                  <select [(ngModel)]="component.framework"
                    class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10">
                    @for (fw of getAvailableFrameworks(component.technology); track fw.value) {
                    <option [value]="fw.value">{{ fw.label }}</option>
                    }
                  </select>
                </div>

                <div class="flex flex-col gap-1">
                  <label class="text-slate-700">Type</label>
                  <select [(ngModel)]="component.type"
                    class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10">
                    <option value="web">Web</option>
                    <option value="api">API</option>
                    <option value="database">Database</option>
                    <option value="database">Gateway</option>
                  </select>
                </div>

                <div class="flex flex-col gap-1">
                  <label class="text-slate-700">Port</label>
                  <input type="number" [(ngModel)]="component.port"
                    class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10" />
                </div>
              </div>
            </div>
            }

            <button class="flex items-center justify-center bg-green-500 py-2 px-4 rounded max-w-[180px]"
              (click)="addComponent()">
              <p class="text-sm text-white-900">Add Component</p>
            </button>

            <button class="flex items-center justify-center bg-ocean-500 py-2 px-4 rounded max-w-[120px]"
              (click)="saveSection()">
              <p class="text-sm text-white-900">Save</p>
            </button>
          </div>
          } @else {
          <!-- View Mode -->
          <div class="flex flex-wrap gap-3">
            @for (item of editedSchema.components; track $index) {
            <div class="flex items-center gap-2 w-auto">
              @if (item.framework.toLowerCase() !== 'none') {
              <ng-icon [name]="getIcon(item.framework)" class=" text-slate-500" size="30"></ng-icon>
              } @else if (item.technology.toLowerCase() !== 'none') {
              <ng-icon [name]="getIcon(item.technology)" class=" text-slate-500" size="30"></ng-icon>
              }
              <p class="text-lg">{{item.name}}</p>
            </div>
            }
          </div>
          }
        </div>
        }

        <!-- Connections Section -->
        @if (!isEditMode || editSection === 'connections') {
        <div class="flex flex-col gap-4">
          <p class="text-lg mt-4">Connections</p>

          @if (isEditMode && editSection === 'connections') {
          <!-- Edit Mode -->
          <div class="flex flex-col gap-4">
            @for (connection of editedSchema.connections; track $index) {
            <div class="border border-ocean-300 rounded p-4 flex flex-col gap-3">
              <div class="flex justify-between items-center">
                <p class="font-semibold text-slate-700">Connection {{ $index + 1 }}</p>
                <button class="text-red-500 text-sm" (click)="removeConnection($index)">
                  Remove
                </button>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div class="flex flex-col gap-1">
                  <label class="text-slate-700">Source</label>
                  <select [(ngModel)]="connection.source"
                    class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10">
                    @for (comp of editedSchema.components; track comp.component_id) {
                    <option [value]="comp.component_id">{{ comp.name }}</option>
                    }
                  </select>
                </div>

                <div class="flex flex-col gap-1">
                  <label class="text-slate-700">Target</label>
                  <select [(ngModel)]="connection.target"
                    class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10">
                    @for (comp of editedSchema.components; track comp.component_id) {
                    <option [value]="comp.component_id">{{ comp.name }}</option>
                    }
                  </select>
                </div>

                <div class="flex flex-col gap-1">
                  <label class="text-slate-700">Type</label>
                  <select [(ngModel)]="connection.type"
                    class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10">
                    <option value="api-call">API Call</option>
                    <option value="database">Database</option>
                  </select>
                </div>

                <div class="flex flex-col gap-1">
                  <label class="text-slate-700">Port</label>
                  <input type="number" [(ngModel)]="connection.port"
                    class="text-slate-500 focus:text-slate-700 border-ocean-400 border rounded border-opacity-50 text-sm py-1 px-2 focus:border-opacity-100 focus:outline-none focus:bg-white-50 bg-ocean-300 bg-opacity-10" />
                </div>
              </div>
            </div>
            }

            <button class="flex items-center justify-center bg-green-500 py-2 px-4 rounded max-w-[180px]"
              (click)="addConnection()">
              <p class="text-sm text-white-900">Add Connection</p>
            </button>

            <button class="flex items-center justify-center bg-ocean-500 py-2 px-4 rounded max-w-[120px]"
              (click)="saveSection()">
              <p class="text-sm text-white-900">Save</p>
            </button>
          </div>
          } @else {
          <!-- View Mode -->
          <div class="flex flex-wrap gap-3">
            @for (item of editedSchema.connections; track $index) {
            <div class="flex items-center gap-2 w-auto">
              <p>{{item.source}} -> {{item.target}}</p>
            </div>
            }
          </div>
          }
        </div>
        }

        @if(projectCreateMessage) {
        <p class="text-green-600 font-medium">{{projectCreateMessage}}</p>
        }

        <!-- Rating Section -->
        <div class="flex flex-col gap-4 mt-4 p-4 border border-ocean-300 rounded-lg bg-ocean-50/30">
          <p class="text-lg font-semibold text-slate-700">Rate Generated Schema</p>

          <!-- Rating Scale -->
          <div class="flex flex-col gap-2">
            <label class="text-sm text-slate-600">How would you rate this schema? (1 = least favorable, 10 = most
              favorable)</label>
            <div class="flex gap-2">
              @for (rating of [1,2,3,4,5,6,7,8,9,10]; track rating) {
              <button (click)="selectedRating = rating" [class.bg-ocean-500]="selectedRating === rating"
                [class.text-white-900]="selectedRating === rating" [class.bg-white-900]="selectedRating !== rating"
                [class.text-ocean-500]="selectedRating !== rating" [class.border-ocean-500]="selectedRating === rating"
                [class.border-ocean-300]="selectedRating !== rating"
                class="w-10 h-10 rounded border-2 hover:border-ocean-500 transition-all font-semibold">
                {{ rating }}
              </button>
              }
            </div>
          </div>

          <!-- Comments Text Area -->
          <div class="w-full">
            <label class="text-sm text-slate-600 mb-1 block">Additional Comments (Optional)</label>
            <div class="relative">
              <textarea [(ngModel)]="ratingComment" placeholder="Share your thoughts about the generated schema..."
                class="w-full min-h-[50px] max-h-[500px] p-3 pr-10 text-slate-700 placeholder-slate-400 bg-slate-50 border-2 border-slate-200 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-all"
                rows="4"></textarea>
              <div>
                <!-- Character Count -->
                <div class="absolute bottom-3 left-3 text-sm text-slate-400">
                  {{ ratingComment.length || 0 }} characters
                </div>
                <!-- Submit Button -->
                <button [disabled]="!selectedRating" (click)="submitRating()"
                  class="absolute bottom-3 right-3 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl">
                  <ng-icon name="heroPaperAirplane" class="text-ocean-900"></ng-icon>
                </button>
              </div>
            </div>
          </div>

          @if(ratingMessage) {
          <p [class.text-green-600]="ratingSuccess" [class.text-red-600]="!ratingSuccess" class="font-medium">
            {{ ratingMessage }}
          </p>
          }
        </div>
      </div>
      }
    </div>
    }
  </div>

  @if (showErrorModal) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white-900 rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-start mb-4">
        <h2 class="text-2xl font-semibold text-slate-900">Unsupported Technologies Detected</h2>
        <button (click)="closeErrorModal()" class="text-slate-500 hover:text-slate-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="mb-4">
        <p class="text-red-600 font-medium">{{ validationErrorMessage }}</p>
      </div>

      @if (unsupportedTechnologies.length > 0) {
      <div class="mb-4">
        <h3 class="font-semibold text-slate-700 mb-2">Unsupported Technologies:</h3>
        <div class="bg-red-50 border border-red-200 rounded p-3">
          <ul class="list-disc list-inside">
            @for (tech of unsupportedTechnologies; track tech) {
            <li class="text-red-700">{{ tech }}</li>
            }
          </ul>
        </div>
      </div>
      }

      @if (unsupportedFrameworks.length > 0) {
      <div class="mb-4">
        <h3 class="font-semibold text-slate-700 mb-2">Unsupported Frameworks:</h3>
        <div class="bg-red-50 border border-red-200 rounded p-3">
          <ul class="list-disc list-inside">
            @for (fw of unsupportedFrameworks; track fw) {
            <li class="text-red-700">{{ fw }}</li>
            }
          </ul>
        </div>
      </div>
      }

      @if (supportedTechnologiesFormatted) {
      <div class="mb-4">
        <h3 class="font-semibold text-slate-700 mb-2">Supported Technologies:</h3>
        <div class="bg-green-50 border border-green-200 rounded p-3">
          <pre class="text-sm text-green-700 whitespace-pre-wrap">{{ supportedTechnologiesFormatted }}</pre>
        </div>
      </div>
      }

      @if (supportedFrameworksFormatted) {
      <div class="mb-4">
        <h3 class="font-semibold text-slate-700 mb-2">Supported Frameworks:</h3>
        <div class="bg-green-50 border border-green-200 rounded p-3">
          <p class="text-sm text-green-700">{{ supportedFrameworksFormatted }}</p>
        </div>
      </div>
      }

      <div class="mb-4">
        <h3 class="font-semibold text-slate-700 mb-2">Edit Your Prompt:</h3>
        <textarea [(ngModel)]="editedPrompt" rows="6"
          class="w-full text-slate-700 border-ocean-400 border rounded text-sm py-2 px-3 focus:border-ocean-500 focus:outline-none focus:ring-1 focus:ring-ocean-500"
          placeholder="Update your prompt to use only supported technologies and frameworks...">
      </textarea>
      </div>

      <div class="flex gap-3 justify-end">
        <button (click)="closeErrorModal()"
          class="px-4 py-2 border border-slate-300 rounded text-slate-700 hover:bg-slate-50">
          Cancel
        </button>
        <button (click)="retryWithUpdatedPrompt()" [disabled]="!editedPrompt.trim()"
          class="px-4 py-2 bg-ocean-500 text-white-900 rounded hover:bg-ocean-600 disabled:opacity-50 disabled:cursor-not-allowed">
          Regenerate Architecture
        </button>
      </div>
    </div>
  </div>
  }
</div>