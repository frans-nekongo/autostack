version: '3.8'

services:
{% for tech in technologies %}
  {{ tech.service_name }}:
    image: {{ tech.image }}
    container_name: {{ project_name }}_{{ tech.service_name }}
    restart: unless-stopped
    {% if tech.ports %}
    ports:
      {% for port in tech.ports %}
      - "{{ port.host }}:{{ port.container }}"
      {% endfor %}
    {% endif %}
    {% if tech.environment_variables %}
    environment:
      {% for key, value in tech.environment_variables.items() %}
      {{ key }}: {{ value }}
      {% endfor %}
    {% endif %}
    {% if tech.volumes %}
    volumes:
      {% for volume in tech.volumes %}
      - {{ volume.host }}:{{ volume.container }}{% if volume.get('mode') %}:{{ volume.mode }}{% endif %}
      {% endfor %}
    {% endif %}
    {% if tech.depends_on %}
    depends_on:
      {% for dep in tech.depends_on %}
      - {{ dep }}
      {% endfor %}
    {% endif %}
    {% if tech.configuration %}
    {% if tech.configuration.get('command') %}
    command: {{ tech.configuration.command }}
    {% endif %}
    {% if tech.configuration.get('healthcheck') %}
    healthcheck:
      test: {{ tech.configuration.healthcheck.test }}
      interval: {{ tech.configuration.healthcheck.get('interval', '30s') }}
      timeout: {{ tech.configuration.healthcheck.get('timeout', '10s') }}
      retries: {{ tech.configuration.healthcheck.get('retries', 3) }}
      start_period: {{ tech.configuration.healthcheck.get('start_period', '40s') }}
    {% endif %}
    {% if tech.configuration.get('networks') %}
    networks:
      {% for network in tech.configuration.networks %}
      - {{ network }}
      {% endfor %}
    {% endif %}
    {% if tech.configuration.get('labels') %}
    labels:
      {% for key, value in tech.configuration.labels.items() %}
      {{ key }}: "{{ value }}"
      {% endfor %}
    {% endif %}
    {% endif %}

{% endfor %}

{% if technologies|selectattr('configuration.networks', 'defined')|list %}
networks:
  {% for tech in technologies %}
  {% if tech.configuration and tech.configuration.get('networks') %}
  {% for network in tech.configuration.networks %}
  {{ network }}:
    driver: bridge
  {% endfor %}
  {% endif %}
  {% endfor %}
{% endif %}

volumes:
{% for tech in technologies %}
  {% if tech.volumes %}
  {% for volume in tech.volumes %}
  {% if not volume.host.startswith('./') and not volume.host.startswith('/') %}
  {{ volume.host }}:
  {% endif %}
  {% endfor %}
  {% endif %}
{% endfor %}